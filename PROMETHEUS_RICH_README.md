# Prometheus Metrics & Rich Logging Integration

This project integrates **Prometheus metrics** and **Rich console logging** to provide comprehensive monitoring and beautiful logging for the facial processing service.

## 🚀 Features

### Prometheus Metrics
- **API Metrics**: Request counts, duration, payload sizes
- **Task Processing**: Submissions, completions, queue sizes, processing times
- **Image Processing**: Decode times, contour extraction, SVG generation
- **System Metrics**: Memory usage, CPU usage, error tracking
- **Custom Instrumentator**: FastAPI auto-instrumentation

### Rich Logging
- **Beautiful Console Output**: Colored, formatted logs with emojis
- **Progress Tracking**: Visual progress bars for long operations  
- **Structured Logging**: Component-specific loggers (API, Tasks, Images)
- **Error Handling**: Rich tracebacks with context
- **Live Dashboards**: Real-time metrics display

## 📊 Available Metrics

### API Metrics
- `api_requests_total` - Total API requests by method/endpoint/status
- `api_request_duration_seconds` - Request processing time
- `api_request_size_bytes` - Request payload sizes
- `api_response_size_bytes` - Response payload sizes

### Task Processing Metrics
- `task_submissions_total` - Tasks submitted by type
- `task_completions_total` - Tasks completed by type/status
- `task_processing_duration_seconds` - Task processing times
- `task_queue_size` - Current queue sizes
- `active_tasks_count` - Currently processing tasks

### Image Processing Metrics
- `image_processing_duration_seconds` - Image operation times
- `landmarks_processed_total` - Total landmarks processed
- `regions_generated_total` - Facial regions generated by type

### System Metrics
- `memory_usage_bytes` - Memory usage by process
- `cpu_usage_percent` - CPU usage by process
- `errors_total` - Errors by type and component

## 🛠️ Setup

### Dependencies
The integration requires these packages (already in `pyproject.toml`):
```toml
"prometheus-client>=0.20.0",
"prometheus-fastapi-instrumentator>=6.1.0",  
"rich>=13.7.0",
```

### Installation
```bash
# Install dependencies
uv pip install -r pyproject.toml

# Or manually
pip install prometheus-client prometheus-fastapi-instrumentator rich
```

## 🚦 Usage

### Running the Service
```bash
# Start the API server
python main.py
```

The service will display a beautiful startup banner and begin logging with Rich formatting.

### Accessing Metrics
- **Metrics Endpoint**: http://localhost:8000/metrics
- **Health Check**: http://localhost:8000/health
- **API Documentation**: http://localhost:8000/docs

### Live Monitoring
Use the included monitoring script to see real-time metrics:
```bash
python monitor_demo.py
```

This shows a live dashboard with:
- Service health status
- Real-time Prometheus metrics
- Auto-refreshing display

## 📝 Logging Examples

### API Request Logging
```
  GET /health 200 15.2ms 192.168.1.1
📋 Task Started abc12345 facial_processing
🖼️ Image decoded: (512, 512, 3)
🗺️ Segmentation map decoded: (512, 512, 3)
✅ Extracted 8 regions
✅ Task Success abc12345 facial_processing 2.34s
```

### Error Logging  
```
❌ Task abc12345 failed: Invalid image data
💥 Image decoding error: Unsupported format
```

### Metrics Logging
```
📊 Metric task_completions_total = 42 task_type=facial_processing status=success
📊 Metric landmarks_processed_total = 20076
```

## 🔍 Monitoring Integration

### Custom Decorators
The integration provides decorators for automatic metrics tracking:

```python
@track_task_metrics('facial_processing')
def process_task():
    # Automatically tracks task metrics
    pass

@track_image_processing('decode')
def decode_image():
    # Automatically tracks image processing metrics
    pass
```

### Manual Metrics Recording
```python
from metrics import record_landmarks_processed, record_region_generated

# Record custom metrics
record_landmarks_processed(478)
record_region_generated('left_eye')
```

### Rich Logging Functions
```python
from rich_logging import log_task_started, log_image_processing

# Log with rich formatting
log_task_started('task123', 'facial_processing')
log_image_processing('decode', (512, 512), 0.123)
```

## 🐳 Docker Integration

The Docker setup automatically:
- Creates logs directory
- Installs all dependencies
- Exposes metrics on port 8000

```bash
# Build and run with Docker
docker-compose up --build
```

## 📈 Grafana Integration

To visualize metrics in Grafana:

1. **Add Prometheus data source**: http://localhost:8000/metrics
2. **Create dashboards** with queries like:
   ```promql
   # API request rate
   rate(api_requests_total[5m])
   
   # Task processing time
   histogram_quantile(0.95, task_processing_duration_seconds_bucket)
   
   # Error rate
   rate(errors_total[5m])
   ```

## 🔧 Configuration

### Metrics Configuration
Customize metrics in `metrics.py`:
- Add new metrics
- Modify buckets for histograms
- Configure instrumentator settings

### Logging Configuration  
Customize logging in `rich_logging.py`:
- Change themes and colors
- Modify log formats
- Add new loggers

### Environment Variables
- `ENABLE_METRICS=true` - Enable/disable metrics collection
- `LOG_LEVEL=INFO` - Set logging level

## 🚨 Health Checks

The service provides comprehensive health checking:
- `/health` endpoint with service status
- Automatic error tracking
- Performance monitoring
- Resource usage tracking

## 📚 Examples

See `monitor_demo.py` for a complete example of:
- Fetching and parsing metrics
- Creating rich dashboards
- Real-time monitoring
- Health status checking

This integration provides production-ready monitoring and logging for the facial processing service with beautiful, informative output and comprehensive metrics collection.